{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="book-detail-container">

  <!-- ✅ 左側（表紙画像・タイトル・著者・登録日） -->
  <div class="book-info">
    <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-cover">
    <h2>{{ book.title }}</h2>
    <p>著者: {{ book.author }}</p>
    <p>登録日: {{ book.created_at|date:"Y年m月d日" }}</p>

    <!-- ✅ 削除ボタン -->
    <form method="POST" action="{% url 'delete_book' book.id %}" onsubmit="return confirm('本当に削除しますか？');">
        {% csrf_token %}
        <button type="submit" class="delete-button">削除</button>
    </form>
  </div>

  <!-- ✅ 右側：登録した子どもの名前表示 -->
  <div class="book-owners" style="text-align: right;">
    {% for child in registered_children %}
      <div class="child-name with-icon" data-child-id="{{ child.id }}">
        <span class="icon">🧑</span>
        {{ child.name }}

        <!-- ⭐ お気に入りトグル -->
        <span class="favorite-star"
              data-book-id="{{ book.id }}"
              data-child-id="{{ child.id }}">
            {% if child.id in favorited_child_ids %}★{% else %}☆{% endif %}
        </span>
      </div>
    {% endfor %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll(".favorite-star");

    stars.forEach(star => {
        star.addEventListener("click", function () {
            const bookId = this.dataset.bookId;
            const childId = this.dataset.childId;

            fetch("{% url 'toggle_favorite' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({ book_id: bookId, child_id: childId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.favorited) {
                    this.textContent = "★";
                    this.classList.add("favorited");
                } else {
                    this.textContent = "☆";
                    this.classList.remove("favorited");
                }
            })
            .catch(error => console.error("❌ 通信エラー:", error));
        });
    });
});
</script>
{% endblock %}
